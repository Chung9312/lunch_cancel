<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>退餐日期選擇</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css" rel="stylesheet">
  <style>
    /* 1. 現代化視覺與間距 */
    :root {
      --primary-color: #4361ee;
      --secondary-color: #3f37c9;
      --accent-color: #4895ef;
      --background-color: #f0f2f5;
      --card-background: #ffffff;
      --text-primary: #2b2d42;
      --text-secondary: #6c757d;
    }
    
    body {
      background: var(--background-color);
      padding: 2rem 1rem;
      font-family: 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif, 'Noto Sans TC';
      color: var(--text-primary);
      line-height: 1.6;
    }

    .card-center {
      max-width: 800px;
      margin: 2rem auto;
      border-radius: 16px;
      box-shadow: 0 12px 28px rgba(0, 0, 0, 0.08);
      border: none;
      background: var(--card-background);
      transition: all 0.3s ease;
    }

    .card-center:hover {
      transform: translateY(-2px);
      box-shadow: 0 16px 32px rgba(0, 0, 0, 0.12);
    }

    .brand { 
      display: flex; 
      align-items: center; 
      gap: 1rem;
      margin-bottom: 1.5rem;
    }

    /* 2. 優化品牌 Logo */
    .brand .logo {
      width: 56px; 
      height: 56px;
      border-radius: 14px;
      background: var(--primary-color);
      color: #fff;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      font-size: 1.75rem;
      box-shadow: 0 4px 12px rgba(67, 97, 238, 0.15);
      transition: all 0.3s ease;
    }

    .brand .logo:hover {
      transform: rotate(-5deg);
    }

    .brand h4 { 
      font-weight: 700;
      color: var(--text-primary);
      margin-bottom: 0.25rem;
    }

    .help-small { 
      font-size: 0.875rem; 
      color: var(--text-secondary);
      line-height: 1.5;
    }

    /* 3. 調整表單樣式 */
    .form-control, .input-group-text {
      padding: 0.75rem 1rem;
      border-radius: 10px;
      border-color: #e0e0e0;
    }

    .form-control:focus {
      border-color: var(--primary-color);
      box-shadow: 0 0 0 3px rgba(67, 97, 238, 0.15);
    }

    .btn-primary {
      background: var(--primary-color);
      border: none;
      padding: 0.75rem 1.5rem;
      border-radius: 10px;
      font-weight: 600;
      transition: all 0.3s ease;
    }

    .btn-primary:hover {
      background: var(--secondary-color);
      transform: translateY(-1px);
    }

    /* 4. 調整列表樣式 */
    #selectedList {
      margin: 0;
      padding: 0;
    }

    #selectedList li { 
      list-style: none; 
      padding: 0.5rem 0.75rem;
      margin-bottom: 0.5rem;
      background: #f8f9fa;
      border-radius: 8px;
      transition: all 0.2s ease;
    }

    #selectedList li:hover {
      background: #eef1f5;
    }
  </style>
</head>
<body>
  <div class="card card-body shadow-sm card-center">
    <div class="d-flex justify-content-between align-items-start mb-3">
      <div class="brand">
        <div class="logo">退</div>
        <div>
          <h4 class="mb-0">退餐日期登記</h4>
          <div class="help-small">請填寫姓名並從日曆多選退餐日期</div>
        </div>
      </div>
      <div class="text-end">
        <small class="text-muted">政附</small>
      </div>
    </div>


    <div class="alert alert-warning mb-4" style="font-size: 1.2rem; font-weight: bold;">
      <i class="bi bi-exclamation-triangle-fill me-2"></i>
      請勿在休假日提交退餐，後台將無法收到資訊！
    </div>

    <form id="mealForm">
      <div class="row g-3">
        <div class="col-12 col-md-6">
          <label class="form-label">姓名</label>
          <input type="text" class="form-control" id="name" placeholder="請輸入姓名" required>
        </div>

        <div class="col-12 col-md-6">
          <label class="form-label">選擇退餐日期（可多選）</label>
          <div class="input-group">
            <span class="input-group-text"><i class="bi bi-calendar2-week"></i></span>
            <input type="text" class="form-control" id="datesPicker" placeholder="點選或拖曳選擇多個日期" readonly>
            <button type="button" class="btn btn-outline-secondary" id="clearDates" title="清除已選日期"><i class="bi bi-x-circle"></i> 清除</button>
          </div>
          <div class="help-small mt-1">
            可用 Ctrl / Command 點選多個日期，或拖曳選擇區間。
            <div id="minNotice" class="mt-2 p-2 bg-light rounded text-danger border border-danger-subtle"></div>
          </div>
        </div>

        <div class="col-12">
          <button type="submit" class="btn btn-primary w-100" id="submitBtn"><i class="bi bi-send-fill me-1"></i> 送出登記</button>
          <div class="mt-2 text-center">
             <button type="button" class="btn btn-outline-secondary btn-sm" id="previewBtn"><i class="bi bi-eye"></i> 預覽已選日期</button>
          </div>
        </div>
      </div>
    </form>

    <div id="msg" class="mt-3"></div>

    <div class="mt-4 pt-3 border-top">
      <h6 class="mb-2 text-primary"><i class="bi bi-calendar-check me-1"></i> 已選退餐日期 (共 <span id="selectedCount">0</span> 日)</h6>
      <ul id="selectedList" class="ps-0 row g-2">
        <li class="col-12 text-muted fst-italic ps-3">尚未選擇任何日期。</li>
      </ul>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
  <script>
    const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbzXaNUsL9eXLUv79-s7oSvnaUnsoj-czYI0AhCY00IgFaVDC1-l2XzSLxbZOUvha1gM/exec';

    // 繁體中文（嘗試提供完整本地化字串）
    const zhTW = {
      weekdays: {
        shorthand: ['日','一','二','三','四','五','六'],
        longhand: ['星期日','星期一','星期二','星期三','星期四','星期五','星期六']
      },
      months: {
        shorthand: ['1月','2月','3月','4月','5月','6月','7月','8月','9月','10月','11月','12月'],
        longhand: ['一月','二月','三月','四月','五月','六月','七月','八月','九月','十月','十一月','十二月']
      },
      rangeSeparator: ' 至 ',
      weekAbbreviation: '週',
      scrollTitle: '滾動切換',
      toggleTitle: '點擊切換',
      firstDayOfWeek: 1
    };

    // 計算至少三個工作日後的最早可選日期
    const now = new Date();
    const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
    
    // 找出符合「至少三個工作日」的最早日期
    function getMinAvailableDate(startDate) {
      let date = new Date(startDate);
      let workDaysNeeded = 3; // 需要三個工作日
      
      while (workDaysNeeded > 0) {
        date.setDate(date.getDate() + 1);
        const dow = date.getDay();
        // 跳過週末（0=週日，6=週六）
        if (dow !== 0 && dow !== 6) {
          workDaysNeeded--;
        }
      }
      
      return date;
    }
    
    const minDate = getMinAvailableDate(today);

    const picker = flatpickr('#datesPicker', {
      mode: 'multiple',
      dateFormat: 'Y-m-d',
      conjunction: ' , ',
      locale: zhTW,
      minDate: minDate,
      onChange: updateSelectedList
    });

    // 6. 優化最早可選日期提示的顯示
    const minNoticeEl = document.getElementById('minNotice');
    // 使用 strong 標籤來強調日期並分行顯示說明
    minNoticeEl.innerHTML = `<div style="font-size: 1.0rem;">⚠️ **最早可選：${formatChineseDate(minDate)}**<br><small class="d-block mt-1" style="font-size: 0.9rem;">（需至少三個工作日前登記，不含週六日）</small>`;

    // 小幫手：只比較日期（忽略時間）
    function dateOnly(d) { return new Date(d.getFullYear(), d.getMonth(), d.getDate()); }

    function formatChineseDate(d) {
      try {
        return d.toLocaleDateString('zh-TW', { year: 'numeric', month: 'long', day: 'numeric' });
      } catch (e) {
        // fallback
        const y = d.getFullYear();
        const m = String(d.getMonth()+1).padStart(2,'0');
        const dd = String(d.getDate()).padStart(2,'0');
        return `${y}年${m}月${dd}日`;
      }
    }

    // 7. 替換優化後的列表更新函式
    function updateSelectedList(selectedDates) {
      const ul = document.getElementById('selectedList');
      ul.innerHTML = '';
      
      // 更新計數器
      document.getElementById('selectedCount').textContent = selectedDates.length; 

      if (selectedDates.length === 0) {
          ul.innerHTML = '<li class="col-12 text-muted fst-italic ps-3">尚未選擇任何日期。</li>';
          return;
      }

      selectedDates.sort((a,b)=>a-b).forEach(d => {
        const li = document.createElement('li');
        // 應用新的列樣式，讓日期橫向排列 (易讀)
        li.classList.add('col-12', 'col-sm-6', 'col-md-4'); 
        li.style.listStyle = 'none'; 
        
        // 使用更醒目的圖標和粗體日期
        li.innerHTML = `<i class="bi bi-check-circle-fill text-success me-2"></i><strong>${formatChineseDate(d)}</strong> <small class="text-muted">(${picker.formatDate(d,'Y-m-d')})</small>`;
        ul.appendChild(li);
      });
    }

    document.getElementById('clearDates').addEventListener('click', () => { picker.clear(); updateSelectedList([]); });
    document.getElementById('previewBtn').addEventListener('click', () => updateSelectedList(picker.selectedDates));

    document.getElementById('mealForm').addEventListener('submit', async e => {
      e.preventDefault();
      const name = document.getElementById('name').value.trim();
      const dates = picker.selectedDates.map(d => picker.formatDate(d, 'Y-m-d'));

      if (!name || dates.length === 0) {
        showMsg('請填寫姓名並選擇至少一個日期', 'danger');
        return;
      }

      // 驗證：確保每個選擇的日期都符合「至少三個工作日前」的規則
      // 此驗證邏輯與 flatpickr 的 minDate 協同工作，確保資料正確性
      for (const selectedDate of picker.selectedDates) {
        const cutoffDate = getMinAvailableDate(dateOnly(selectedDate));
        if (dateOnly(now) > cutoffDate) {
          showMsg(`所選日期（${formatChineseDate(selectedDate)}）需至少三個工作日前登記。`, 'danger');
          return;
        }
      }

      const payload = { name, dates };
      const submitBtn = document.getElementById('submitBtn');
      submitBtn.disabled = true;
      const originalText = submitBtn.innerHTML;
      submitBtn.innerHTML = `<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> 傳送中...`;

      try {
        const resp = await fetch(SCRIPT_URL, {
          method: 'POST',
          body: JSON.stringify(payload),
          headers: { 'Content-Type': 'text/plain' }
        });
        const result = await resp.json();
        if (result.status === 'success') {
          showMsg('登記成功！', 'success');
          document.getElementById('mealForm').reset();
          picker.clear();
          updateSelectedList([]);
        } else {
          showMsg('發生錯誤，請再試一次', 'danger');
        }
      } catch (err) {
        showMsg('網路錯誤：' + err.message, 'danger');
      } finally {
        submitBtn.disabled = false;
        submitBtn.innerHTML = originalText;
      }
    });

    function showMsg(text, type) {
      const el = document.getElementById('msg');
      el.innerHTML = `<div class="alert alert-${type} py-2">${text}</div>`;
      setTimeout(() => el.innerHTML = '', 4000);
    }
  </script>
</body>

</html>

