<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>退餐日期選擇</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css" rel="stylesheet">
  <style>
    /* 1. 現代化視覺與間距 */
    body {
      background: #eee7e7; /* 淺灰色背景更柔和 */
      padding: 3rem 1rem; /* 增加頂部和底部間距 */
      font-family: 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif, 'Noto Sans TC'; /* 現代字體堆棧 */
    }
    .card-center {
      background-color: #fae9e9; /* 如果要保持白色，或者改成 #fae3e3 淺粉色 */
      max-width: 800px; /* 略微增加卡片寬度 */
      margin: 0 auto;
      border-radius: 12px; /* 更圓潤的邊角 */
      box-shadow: 0 10px 25px rgba(0, 0, 0, 0.05), 0 5px 10px rgba(0, 0, 0, 0.03); /* 更精緻的陰影 */
      border: none; /* 移除預設的邊框 */
    }
    .brand { display: flex; align-items: center; gap: .75rem; }
    /* 2. 優化品牌 Logo */
    .brand .logo {
      width: 50px; 
      height: 50px;
      border-radius: 10px;
      background: #0d6efd;
      color: #fff;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      font-size: 1.5rem;
    }
    .brand h4 { font-weight: 600; }
    .help-small { font-size: .85rem; color: #6c757d; }
    /* 3. 調整列表樣式 */
    #selectedList li { list-style: none; padding: .15rem 0; }
  </style>
</head>
<body>
  <div class="card card-body shadow-sm card-center">
    <div class="d-flex justify-content-between align-items-start mb-3">
      <div class="brand">
        <div class="logo">退</div>
        <div>
          <h4 class="mb-0">退餐日期登記</h4>
          <div class="help-small">請填寫姓名並從日曆多選退餐日期</div>
        </div>
      </div>
      <div class="text-end">
        <small class="text-muted">政附</small>
      </div>
    </div>


    <div class="alert alert-warning mb-4" style="font-size: 1.2rem; font-weight: bold;">
      <i class="bi bi-exclamation-triangle-fill me-2"></i>
      請勿在16:00後或休假日提交退餐，後台將無法收到資訊！
    </div>

    <form id="mealForm">
      <div class="row g-3">
        <h5 class="mb-1 text-secondary"><i class="bi bi-person-dash me-2"></i> 個人退餐 </h5>
        <div class="col-12 col-md-6">
          <label class="form-label">姓名</label>
          <input type="text" class="form-control" id="name" placeholder="請輸入姓名" required>
        </div>

        <div class="col-12 col-md-6">
          <label class="form-label">選擇退餐日期（可多選）</label>
          <div class="input-group">
            <span class="input-group-text"><i class="bi bi-calendar2-week"></i></span>
            <input type="text" class="form-control" id="datesPicker" placeholder="可點選多個日期" readonly>
            <button type="button" class="btn btn-outline-secondary" id="clearDates" title="清除已選日期"><i class="bi bi-x-circle"></i> 清除</button>
          </div>
          <div class="help-small mt-1">
            可點選多個日期。
            <div id="minNotice" class="mt-2 p-2 bg-light rounded text-danger border border-danger-subtle"></div>
          </div>
        </div>

        <div class="col-12">
          <button type="submit" class="btn btn-primary w-100" id="submitBtn"><i class="bi bi-send-fill me-1"></i> 送出登記</button>
          <div class="mt-2 text-center">
             <button type="button" class="btn btn-outline-secondary btn-sm" id="previewBtn"><i class="bi bi-eye"></i> 預覽已選日期</button>
          </div>
        </div>
      </div>
    </form>

    <div id="msg" class="mt-3"></div>

    <div class="mt-4 pt-3 border-top">
      <h6 class="mb-2 text-primary"><i class="bi bi-calendar-check me-1"></i> 已選退餐日期 (共 <span id="selectedCount">0</span> 日)</h6>
      <ul id="selectedList" class="ps-0 row g-2">
        <li class="col-12 text-muted fst-italic ps-3">尚未選擇任何日期。</li>
      </ul>
    </div>

    <div class="mt-4 pt-3 border-top">
      <h5 class="mb-3 text-secondary"><i class="bi bi-building-dash me-2"></i> 會議退餐（Excel：A欄=姓名，B欄=退餐日期）</h5>
      <div class="input-group">
        <input type="file" accept=".xlsx,.xls" id="excelFile" class="form-control" aria-label="Excel檔案">
        <button type="button" id="parseExcelBtn" class="btn btn-outline-secondary"><i class="bi bi-cloud-arrow-up"></i> 讀取檔案</button>
        <button type="button" id="sendBatchBtn" class="btn btn-primary"><i class="bi bi-send-fill"></i> 匯入並送出</button>
      </div>
      <div id="batchMsg" class="mt-2"></div> <div class="help-small mt-1 text-muted d-flex justify-content-between align-items-center">
        <span>請確認 Excel 檔案中 A 欄為姓名，B 欄為退餐日期。</span>
        <div>
            <a href="會議退餐操作說明.pdf" download class="text-decoration-none me-3">
                <i class="bi bi-file-earmark-pdf me-1"></i>下載操作說明
            </a>
            <a href="批次訂餐(範例).xlsx" download class="text-decoration-none">
                <i class="bi bi-file-earmark-excel me-1"></i>下載範例檔案
            </a>
        </div>
      </div>
      <div id="excelPreview" class="mt-3"></div>
    </div>
    <span>©This webpage was created by Hsieh Hung-Chung.</span>
    </div>

  <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
  <script>
    const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbzXaNUsL9eXLUv79-s7oSvnaUnsoj-czYI0AhCY00IgFaVDC1-l2XzSLxbZOUvha1gM/exec';

    // 繁體中文（嘗試提供完整本地化字串）
    const zhTW = {
      weekdays: {
        shorthand: ['日','一','二','三','四','五','六'],
        longhand: ['星期日','星期一','星期二','星期三','星期四','星期五','星期六']
      },
      months: {
        shorthand: ['1月','2月','3月','4月','5月','6月','7月','8月','9月','10月','11月','12月'],
        longhand: ['一月','二月','三月','四月','五月','六月','七月','八月','九月','十月','十一月','十二月']
      },
      rangeSeparator: ' 至 ',
      weekAbbreviation: '週',
      scrollTitle: '滾動切換',
      toggleTitle: '點擊切換',
      firstDayOfWeek: 1
    };

    // 計算至少三個工作日後的最早可選日期
    const now = new Date();
    const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
    
    // 找出符合「至少三個工作日」的最早日期
    function getMinAvailableDate(startDate) {
      let date = new Date(startDate);
      let workDaysNeeded = 3; // 需要三個工作日
      
      while (workDaysNeeded > 0) {
        date.setDate(date.getDate() + 1);
        const dow = date.getDay();
        // 跳過週末（0=週日，6=週六）
        if (dow !== 0 && dow !== 6) {
          workDaysNeeded--;
        }
      }
      
      return date;
    }
    
    const minDate = getMinAvailableDate(today);

    const picker = flatpickr('#datesPicker', {
      mode: 'multiple',
      dateFormat: 'Y-m-d',
      conjunction: ' , ',
      locale: zhTW,
      minDate: minDate,
      onChange: updateSelectedList
    });

    // 優化最早可選日期提示的顯示
    const minNoticeEl = document.getElementById('minNotice');
    minNoticeEl.innerHTML = `<div style="font-size: 1.0rem;">⚠️ **最早可選：${formatChineseDate(minDate)}** ⚠️<br><small class="d-block mt-1" style="font-size: 0.9rem;">（需至少三個工作日前登記，不含週六日）</small>`;

    // 小幫手：只比較日期（忽略時間）
    function dateOnly(d) { return new Date(d.getFullYear(), d.getMonth(), d.getDate()); }

    function formatChineseDate(d) {
      try {
        return d.toLocaleDateString('zh-TW', { year: 'numeric', month: 'long', day: 'numeric' });
      } catch (e) {
        // fallback
        const y = d.getFullYear();
        const m = String(d.getMonth()+1).padStart(2,'0');
        const dd = String(d.getDate()).padStart(2,'0');
        return `${y}年${m}月${dd}日`;
      }
    }

    // 列表更新函式
    function updateSelectedList(selectedDates) {
      const ul = document.getElementById('selectedList');
      ul.innerHTML = '';
      
      // 更新計數器
      document.getElementById('selectedCount').textContent = selectedDates.length; 

      if (selectedDates.length === 0) {
          ul.innerHTML = '<li class="col-12 text-muted fst-italic ps-3">尚未選擇任何日期。</li>';
          return;
      }

      selectedDates.sort((a,b)=>a-b).forEach(d => {
        const li = document.createElement('li');
        li.classList.add('col-12', 'col-sm-6', 'col-md-4'); 
        li.style.listStyle = 'none'; 
        
        li.innerHTML = `<i class="bi bi-check-circle-fill text-success me-2"></i><strong>${formatChineseDate(d)}</strong> <small class="text-muted">(${picker.formatDate(d,'Y-m-d')})</small>`;
        ul.appendChild(li);
      });
    }

    document.getElementById('clearDates').addEventListener('click', () => { picker.clear(); updateSelectedList([]); });
    document.getElementById('previewBtn').addEventListener('click', () => updateSelectedList(picker.selectedDates));

    document.getElementById('mealForm').addEventListener('submit', async e => {
      e.preventDefault();
      const name = document.getElementById('name').value.trim();
      const dates = picker.selectedDates.map(d => picker.formatDate(d, 'Y-m-d'));

      if (!name || dates.length === 0) {
        showMsg('請填寫姓名並選擇至少一個日期', 'danger');
        return;
      }

      // 驗證截止日期
      for (const selectedDate of picker.selectedDates) {
        const cutoffDate = getMinAvailableDate(dateOnly(selectedDate));
        if (dateOnly(now) > cutoffDate) {
          showMsg(`所選日期（${formatChineseDate(selectedDate)}）需至少三個工作日前登記。`, 'danger');
          return;
        }
      }

      const payload = { name, dates };
      const submitBtn = document.getElementById('submitBtn');
      submitBtn.disabled = true;
      const originalText = submitBtn.innerHTML;
      submitBtn.innerHTML = `<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> 傳送中...`;

      try {
        const resp = await fetch(SCRIPT_URL, {
          method: 'POST',
          body: JSON.stringify(payload),
          headers: { 'Content-Type': 'text/plain' }
        });
        const result = await resp.json();
        if (result.status === 'success') {
          showMsg('登記成功！', 'success');
          document.getElementById('mealForm').reset();
          picker.clear();
          updateSelectedList([]);
        } else {
          showMsg('發生錯誤，請再試一次', 'danger');
        }
      } catch (err) {
        showMsg('網路錯誤：' + err.message, 'danger');
      } finally {
        submitBtn.disabled = false;
        submitBtn.innerHTML = originalText;
      }
    });

    function showMsg(text, type) {
      const el = document.getElementById('msg');
      el.innerHTML = `<div class="alert alert-${type} py-2">${text}</div>`;
      setTimeout(() => el.innerHTML = '', 4000);
    }
    
    // **新增：用於顯示批次送出結果的函式**
    function showBatchMsg(text, type) {
      const el = document.getElementById('batchMsg'); // 指向新的 batchMsg 容器
      el.innerHTML = `<div class="alert alert-${type} py-2">${text}</div>`;
      setTimeout(() => el.innerHTML = '', 6000); // 批次結果保留久一點
    }
    
    // --- Excel 匯入功能 (整合自原版) ---
    let importedGroups = {}; // 儲存解析後的資料

    document.getElementById('parseExcelBtn').addEventListener('click', () => {
      const f = document.getElementById('excelFile').files[0];
      if (!f) { showBatchMsg('請先選擇 Excel 檔案', 'danger'); return; } // 使用 showBatchMsg
      readExcelFile(f);
    });

    async function readExcelFile(file) {
      const reader = new FileReader();
      reader.onload = (e) => {
        try {
          const data = new Uint8Array(e.target.result);
          // 使用 XLSX.read 讀取檔案
          const workbook = XLSX.read(data, { type: 'array' });
          const sheet = workbook.Sheets[workbook.SheetNames[0]];
          // 轉換為 JSON 陣列，header: 1 表示將第一行作為資料的一部分
          const rows = XLSX.utils.sheet_to_json(sheet, { header: 1, defval: '' });
          
          const entries = [];
          for (let i=0;i<rows.length;i++){
            const row = rows[i];
            const name = String(row[0]||'').trim(); // A欄為姓名
            const rawDate = row[1]; // B欄為日期
            
            if (!name) continue; // 忽略沒有姓名的行
            if (rawDate === '' || rawDate === null || rawDate === undefined) { 
                entries.push({name, raw: rawDate, date: null}); continue; 
            }
            
            let dateObj = null;
            // 嘗試解析 Excel 數字日期
            if (typeof rawDate === 'number') dateObj = excelDateToJSDate(rawDate);
            // 嘗試解析字串日期
            else { 
                const tryDate = new Date(String(rawDate)); 
                if (!isNaN(tryDate)) dateObj = tryDate; 
                else { 
                    const parsed = Date.parse(String(rawDate).replace(/\.|\//g,'-')); 
                    if (!isNaN(parsed)) dateObj = new Date(parsed); 
                } 
            }
            entries.push({ name, raw: rawDate, date: dateObj });
          }
          
          // 將有效日期按姓名分組
          const groups = {};
          entries.forEach(e=>{ 
            if (!e.date) return; 
            // 確保日期物件只包含日期部分，方便後續比較
            const dateOnlyObj = new Date(e.date.getFullYear(), e.date.getMonth(), e.date.getDate()); 
            if (!groups[e.name]) groups[e.name]=[]; 
            groups[e.name].push(dateOnlyObj); 
          });
          
          importedGroups = groups; 
          renderPreview(entries, groups);
        } catch(err){ 
          showBatchMsg('解析 Excel 失敗：' + err.message, 'danger'); // 使用 showBatchMsg
        }
      };
      reader.readAsArrayBuffer(file);
    }

    // 將 Excel 序列日期轉換為 JavaScript Date 物件
    function excelDateToJSDate(serial){ 
      const utc_days = Math.floor(serial - 25569); 
      const utc_value = utc_days * 86400; 
      const fractional_day = serial - Math.floor(serial); 
      const total_seconds = Math.round(86400 * fractional_day); 
      const date = new Date((utc_value + total_seconds) * 1000); 
      // 確保只返回日期部分
      return new Date(date.getFullYear(), date.getMonth(), date.getDate()); 
    }

    // 渲染 Excel 預覽表格
    function renderPreview(entries, groups){ 
      const el = document.getElementById('excelPreview'); 
      if (!entries || entries.length===0){ 
        el.innerHTML = '<div class="text-muted">未讀取到資料</div>'; 
        return; 
      } 
      
      let html = `<div class="small text-muted mb-2">共讀取 ${entries.length} 筆資料。</div>`; 
      
      html += '<div class="table-responsive"><table class="table table-sm table-bordered"><thead><tr><th>姓名</th><th>日期（原始值）</th><th>解析結果</th><th>狀態</th></tr></thead><tbody>'; 
      
      entries.forEach(e=>{ 
        // 檢查日期是否有效且不早於 minDate
        let statusText = '';
        let statusClass = '';
        if (e.date) {
            const dateOnlyObj = dateOnly(e.date);
            if (dateOnlyObj < minDate) {
                statusText = '日期過早(無效)';
                statusClass = 'text-warning';
            } else {
                statusText = '有效日期';
                statusClass = 'text-success';
            }
        } else {
            statusText = '日期無效或缺失';
            statusClass = 'text-danger';
        }

        html += `<tr>
                  <td>${escapeHtml(e.name)}</td>
                  <td>${escapeHtml(String(e.raw))}</td>
                  <td>${e.date ? escapeHtml(formatChineseDate(e.date)) : '<span class="text-danger">無效日期</span>'}</td>
                  <td class="${statusClass}">${statusText}</td>
                </tr>`; 
      }); 
      
      html += '</tbody></table></div>'; 
      el.innerHTML = html; 
    }

    // 批次送出功能
    document.getElementById('sendBatchBtn').addEventListener('click', async () => {
      const keys = Object.keys(importedGroups || {});
      if (keys.length === 0) { showBatchMsg('沒有可送出的資料，請先讀取 Excel 並確認有有效日期。', 'danger'); return; } // 使用 showBatchMsg
      
      const btn = document.getElementById('sendBatchBtn'); 
      btn.disabled = true; 
      const orig = btn.innerHTML; 
      btn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> 傳送中...';
      
      let success = 0, fail = 0;
      
      for (const name of keys){ 
        const dates = importedGroups[name]; 
        // 過濾掉早於最早可選日期的日期
        const filtered = dates.filter(d => dateOnly(d) >= dateOnly(minDate)); 
        
        if (filtered.length === 0){ 
          fail++; 
          continue; 
        } 
        
        const payload = { 
          name, 
          dates: filtered.map(d => picker.formatDate(d,'Y-m-d')) // 轉換為 YYYY-MM-DD 格式
        }; 
        
        try{ 
          const resp = await fetch(SCRIPT_URL, { 
            method:'POST', 
            body: JSON.stringify(payload), 
            headers: { 'Content-Type': 'text/plain' } 
          }); 
          const result = await resp.json(); 
          if (result && result.status === 'success') success++; 
          else fail++; 
        } catch(err){ 
          fail++; 
        } 
      }
      
      btn.disabled = false; 
      btn.innerHTML = orig; 
      showBatchMsg(`批次完成：成功 ${success} 筆，失敗 ${fail} 筆。`, success > 0 ? 'success' : 'danger'); // **使用 showBatchMsg**
    });

    // HTML 轉義工具函式 (防止 XSS)
    function escapeHtml(s){ 
      return String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;'); 
    }
    
  </script>
</body>


</html>

